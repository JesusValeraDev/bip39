name: Lighthouse CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  lighthouse:
    name: Lighthouse Performance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build project
        run: npm run build
        
      - name: Start preview server
        run: npm run preview &
        
      - name: Wait for server to be ready
        run: npx wait-on http://localhost:4173 --timeout 30000
        
      - name: Run Lighthouse CI
        run: npm run lighthouse
        
      - name: Display Lighthouse scores
        if: always()
        run: |
          if [ -d .lighthouseci ]; then
            echo "üìä Lighthouse CI Results:"
            LATEST_REPORT=$(ls -t .lighthouseci/lhr-*.json | head -1)
            if [ -f "$LATEST_REPORT" ]; then
              node -e "
                const data = JSON.parse(require('fs').readFileSync('$LATEST_REPORT', 'utf8'));
                const cats = data.categories;
                console.log('‚ö° Performance:', Math.round(cats.performance.score * 100) + '%');
                console.log('‚ôø Accessibility:', Math.round(cats.accessibility.score * 100) + '%');
                console.log('‚úÖ Best Practices:', Math.round(cats['best-practices'].score * 100) + '%');
                console.log('üîç SEO:', Math.round(cats.seo.score * 100) + '%');
              "
            fi
          else
            echo "‚ö†Ô∏è No Lighthouse results found"
          fi
